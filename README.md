# PyroPT

[![Version](https://img.shields.io/badge/version-1.0-purple.svg)](https://github.com/PyroPT/PyroPT)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](https://opensource.org/licenses/MIT)
[![Python](https://img.shields.io/badge/python-3.9%2B-blue.svg)](https://www.python.org/)
[![Streamlit](https://img.shields.io/badge/streamlit-1.28%2B-red.svg)](https://streamlit.io/)
[![DOI](https://img.shields.io/badge/DOI-10.1000%2Fxyz123-blue.svg)](https://doi.org/10.1000/xyz123)

Developed by: Gary J O'Sullivan (gjosulli@tcd.ie) & Dónal Mulligan (donal.mulligan@dcu.ie).  
To notify us of bugs or issues, please email using the subject line `PyroPT Issue Report`   
<small>PyroPT is based on ERC-CoG-2020 LITHO3 research funded by the European Union.</small>

## What is PyroPT?
PyroPT is an application for generating pressures (P) and temperatures (T) from individual Cr-rich peridotitic pyrope-rich garnet from the Earth’s continental lithospheric mantle. Pressures and temperatures of materials from the continental lithospheric mantle can be used to estimate lithosphere thickness, diamond growth conditions and the vertical distribution of peridotite lithologies and metasomatism. By enabling the extraction of P-T from individual garnet, which are very common in kimberlite pipes and derived detritus, we can vastly expand our knowledge of Earth’s lithospheric mantle in comparison with existing methods.

## Quick Start
**The app is built for Streamlit** - *an open-source Python framework for data scientists* - to provide an easy to use interface in your browser. You can explore it on Streamlit Community Cloud or run it on your own machine. **Visit [pyropt.streamlit.app](https://pyropt.streamlit.app/) to get started**, or scroll down to read more about the online version or to [follow the installation instructions](#installation) to run it on your machine.

## How does PyroPT work?
PyroPT uses a machine learning algorithm, K-nearest-neighbour (KNN), to generate estimates of P and T from suitable<sup>\*</sup> peridotitic garnet. The KNN algorithm establishes a scaled compositional space inhabited by training data of known composition and known pressure and/or temperature. We can then input unknown datapoints into the scaled compositional space. Estimates of pressure and temperature are then generated by taking the average pressure and/or temperature of the K nearest neighbours to the unknown based on their scaled compositional similarity. The KNN pressure model uses concentrations of Al 2 O 3 , CaO, TiO 2 and MgO in suitable<sup>\*</sup> garnet to estimate P. The KNN temperature model uses concentrations of MnO, CaO, TiO 2 and MgO in suitable<sup>\*</sup> garnet to estimate T.

The data used to train the PyroPT KNN models for pressure and temperature come from published natural peridotite xenolith datasets. Xenoliths are chunks of the lithospheric mantle that contain different minerals, brought to the Earth’s surface by trans-lithospheric volcanic eruptions (kimberlites and lamproites) as cargo. Importantly, the ratios of cations in co-existing phases in xenoliths obey the laws of thermodynamics under equilibrium conditions and can be modelled; this is the basis of cation-exchange thermobarometry. We generated pressures and temperatures for xenoliths using the garnet-orthopyroxene Al-exchange barometer of Nickel and
Green (1985), modified after Carswell and Gibb (1987), in iterative combination with the garnet-orthopyroxene Fe-Mg exchange thermometer of Sudholz et al. (2022), with prior calculation of Fe 2 O 3 according to a modification of the method of Droop (1987) accounting for natural abundances of Fe 2 O 3 in garnet and orthopyroxene (Nimis et al., 2015). The model is trained upon the compositions, P and T of garnet involved in these pressure and temperature calculations. It is only possible to generate pressures and temperature for garnet in our training data in xenoliths
that contain co-existing orthopyroxene. But the key to these models is that they enable estimation of P and T in garnet from individual crystals – a vastly more abundant resource than xenoliths.

> \* <small>Suitable high-quality garnet data that come from the same compositional range as the training dataset. This largely corresponds to the G9, G10 and G11 classes of Grütter (2004), but excludes some exceptionally high-Cr G10D garnet that only occur in inclusions of pyrope in diamond, and analyses with poor totals or other defects or unusual quirks.</small>

#### References
<small>
   Carswell, D.A. and Gibb, F.G.F., 1987. *Evaluation of mineral thermometers and barometers applicable to garnet lherzolite assemblages.* Contributions to Mineralogy and Petrology, 95(4), pp.499-511.  
   
   Droop, G.T.R., 1987. *A general equation for estimating Fe3+ concentrations in ferromagnesian silicates and oxides from microprobe analyses, using stoichiometric criteria*. Mineralogical magazine, 51(361), pp.431-435.
   
   Grütter, H.S., Gurney, J.J., Menzies, A.H. and Winter, F., 2004. *An updated classification scheme for mantle-derived garnet, for use by diamond explorers*. Lithos, 77(1-4), pp.841-857.

   Nickel K.G. and Green, D.H., 1985. *Empirical geothermobarometry for garnet peridotites and implications for the nature of the lithosphere, kimberlites and diamonds*. Earth Planet Sci Lett 73, pp. 158-170
   
   Nimis, P., Goncharov, A., Ionov, D.A. and McCammon, C., 2015. *Fe3+ partitioning systematics between orthopyroxene and garnet in mantle peridotite xenoliths and implications for thermobarometry of oxidized and reduced mantle rocks* Contributions to Mineralogy and Petrology, 169(1), p.6.
   
   Sudholz, Z.J., Green, D.H., Yaxley, G.M. and Jaques, A.L., 2022. *Mantle geothermometry: experimental evaluation and recalibration of Fe–Mg geothermometers for garnet-clinopyroxene and garnet-orthopyroxene in peridotite, pyroxenite and eclogite systems*. Contributions to Mineralogy and Petrology, 177(8), p.77.
</small>

## Online App: *Run PyroPT on Streamlit Community Cloud*

PyroPT is available to use online, with no installations required. This option has some limitations on the .CSV file of samples you provide *(<1MB, <2,000 rows of data)*, but these should be sufficient for most uses.

**Visit [pyropt.streamlit.app](https://pyropt.streamlit.app/) to use the latest hosted version.**

<small>Your uploaded files/data are not saved or stored, and data transfered to this service is subject to strict and high standards. See [Streamlit documentation](https://docs.streamlit.io/deploy/streamlit-community-cloud/get-started/trust-and-security) for more detail.</small>

## Installation

For users who prefer to retain all data on their own machine and/or wish to use the app with higher limits on the input .CSV file, a local installation of the app may be more suitable.

1. **Install prerequisites**
   - Python 3.9 or newer
   - Git

2. **Clone the repository**
   ```bash
   git clone https://github.com/PyroPT/PyroPT.git
   cd PyroPT
   ```

3. **Create and activate a virtual environment** (*optional, but recommended*)
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate  # On Mac
   # On Windows use: .venv\Scripts\activate
   ```

4. **Install Streamlit and dependencies**
   ```bash
   pip install --upgrade pip
   pip install -r requirements.txt
   ```

5. **Start the app (*with the same limits as the online version*)**
   ```bash
   streamlit run pyropt.py
   ```

   When run without extra flags, the default upload limits match the hosted version. (CSV files with a max of 1 MB and 2,000 data rows)

6. **OR Start the app with relaxed limits**
   You can relax or customise the limits for your input CSV file when running locally by passing flags after a `--` separator so that Streamlit forwards them to the app:
   
   **local-mode** for higher default limits
   ```bash
   streamlit run pyropt.py -- --local_mode
   ```
   Sets 10 MB and 20 000-row limits.
   
   **max-upload-mb** and **max-upload-rows** to specify limits
    ```bash
   streamlit run pyropt.py -- --max-upload-mb 50 --max-upload-rows 23000
   ```
   These flags replace the defaults with your chosen values.
   
   Flags can be combined; for example you can use `--local_mode` along with a custom row limit. If you omit a flag, the corresponding default (cloud or local) remains in effect.

